# Breakpoint æ–­ç‚¹è°ƒè¯•è·¯çº¿å›¾

## å½“å‰çŠ¶æ€ (v1.2)

### å·²å®ç°
- âœ… æ–­ç‚¹è§„åˆ™åˆ›å»ºå’Œç®¡ç†
- âœ… è¯·æ±‚/å“åº”æ–­ç‚¹ç±»å‹
- âœ… URL åŒ¹é…ï¼ˆç²¾ç¡®ã€å‰ç¼€ã€æ­£åˆ™ï¼‰
- âœ… HTTP æ–¹æ³•åŒ¹é…
- âœ… è§„åˆ™å¯ç”¨/ç¦ç”¨
- âœ… å®æ—¶åŒæ­¥åˆ°è®¾å¤‡

### âš ï¸ å¾…ä¿®å¤é—®é¢˜
- ğŸ”´ **P0: åè®®å±‚æ¶ˆæ¯æ ¼å¼ä¸ä¸€è‡´**
  - iOS SDK å’Œ DebugHub çš„ BreakpointResume æ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…
  - å¯¼è‡´æ–­ç‚¹æ¢å¤æ¶ˆæ¯è§£ç å¤±è´¥
  
- ğŸ”´ **P0: ç½‘ç»œå±‚æœªé›†æˆæ–­ç‚¹**
  - `CaptureURLProtocol.startLoading()` æœªè°ƒç”¨ `BreakpointEngine.shared.checkRequestBreakpoint()`
  - å³ä½¿è§„åˆ™åŒæ­¥æˆåŠŸï¼Œæ–­ç‚¹ä¹Ÿä¸ä¼šç”Ÿæ•ˆ

- ğŸŸ¡ **P2: breakpointHit æ¶ˆæ¯æœªå¤„ç†**
  - DebugHub æœªå¤„ç† iOS SDK å‘é€çš„ `breakpointHit` æ¶ˆæ¯
  - WebUI æ— æ³•æ„ŸçŸ¥æ–­ç‚¹å‘½ä¸­

---

## Phase 0: Bug ä¿®å¤ (ä¼˜å…ˆçº§: ğŸ”´ Critical)

### 0.1 æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€

**é—®é¢˜å®šä½**:
```swift
// iOS SDK - BridgeMessage.swift
struct BreakpointResumePayload {
    let breakpointId: String
    let requestId: String
    let action: String  // â† ç®€å•å­—ç¬¦ä¸²
    let modifiedRequest: ModifiedRequest?
}

// DebugHub - DeviceRegistry.swift
struct BreakpointResumeDTO {
    let requestId: String
    let action: BreakpointActionDTO  // â† åµŒå¥—å¯¹è±¡
}
```

**ä¿®å¤æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ç®€å•å­—ç¬¦ä¸²æ ¼å¼

**é¢„ä¼°**: 0.5 å¤©

---

### 0.2 ç½‘ç»œå±‚é›†æˆ

**ä¿®å¤ä½ç½®**: `iOSProbe/Sources/Network/CaptureURLProtocol.swift`

```swift
override func startLoading() {
    // æ£€æŸ¥è¯·æ±‚æ–­ç‚¹
    if let rule = BreakpointEngine.shared.checkRequestBreakpoint(for: request) {
        // æš‚åœè¯·æ±‚ï¼Œç­‰å¾… Hub å“åº”
        BreakpointEngine.shared.pauseRequest(request, rule: rule)
        return
    }
    
    // ç»§ç»­æ­£å¸¸è¯·æ±‚
    executeRequest()
}
```

**é¢„ä¼°**: 1 å¤©

---

### 0.3 breakpointHit å¤„ç†

**ä¿®å¤ä½ç½®**: `DebugHub/Sources/WebSocket/DebugBridgeHandler.swift`

```swift
case "breakpointHit":
    let payload = try decoder.decode(BreakpointHitPayload.self, from: data)
    // è½¬å‘åˆ° WebUI
    await RealtimeStreamHandler.broadcast(
        deviceId: deviceId,
        event: .breakpointHit(payload)
    )
```

**é¢„ä¼°**: 0.5 å¤©

---

## Phase 1: æ ¸å¿ƒåŠŸèƒ½å®Œå–„ (ä¼˜å…ˆçº§: ğŸ”´ High)

### 1.1 è¯·æ±‚ä¿®æ”¹

**ç›®æ ‡**: åœ¨æ–­ç‚¹å‘½ä¸­æ—¶ä¿®æ”¹è¯·æ±‚å†…å®¹

**å¯ä¿®æ”¹é¡¹**:
- URL / Path / Query
- Headers
- Body
- Method

**UI**:
```
â”Œâ”€ æ–­ç‚¹å‘½ä¸­: POST /api/login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Headers] [Body] [Query]                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ {                                          â”‚ â”‚
â”‚  â”‚   "username": "test",                      â”‚ â”‚
â”‚  â”‚   "password": "modified_password"  â† ä¿®æ”¹  â”‚ â”‚
â”‚  â”‚ }                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [ç»§ç»­] [ä¸¢å¼ƒ] [ä¿®æ”¹åç»§ç»­]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢„ä¼°**: 3 å¤©

---

### 1.2 å“åº”ä¿®æ”¹

**ç›®æ ‡**: åœ¨å“åº”æ–­ç‚¹å‘½ä¸­æ—¶ä¿®æ”¹å“åº”å†…å®¹

**å¯ä¿®æ”¹é¡¹**:
- Status Code
- Headers
- Body

**é¢„ä¼°**: 2 å¤©

---

### 1.3 æ¡ä»¶æ–­ç‚¹

**ç›®æ ‡**: åªåœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘æ–­ç‚¹

**æ¡ä»¶é…ç½®**:
```typescript
interface BreakpointCondition {
  // è¯·æ±‚æ¡ä»¶
  headers?: Record<string, string | RegExp>
  query?: Record<string, string | RegExp>
  body?: {
    path: string  // JSONPath
    value: string | RegExp
  }
  
  // æ‰§è¡Œæ¡ä»¶
  hitCount?: number  // å‘½ä¸­æ¬¡æ•°åè§¦å‘
  timeRange?: [string, string]  // æ—¶é—´èŒƒå›´å†…è§¦å‘
}
```

**é¢„ä¼°**: 3 å¤©

---

### 1.4 æ–­ç‚¹å‘½ä¸­é€šçŸ¥

**ç›®æ ‡**: æ–­ç‚¹å‘½ä¸­æ—¶å³æ—¶é€šçŸ¥

**é€šçŸ¥æ–¹å¼**:
- WebUI å¼¹çª—
- å£°éŸ³æç¤º
- æ¡Œé¢é€šçŸ¥

**é¢„ä¼°**: 1 å¤©

---

## Phase 2: è°ƒè¯•å¢å¼º (ä¼˜å…ˆçº§: ğŸŸ¡ Medium)

### 2.1 æ–­ç‚¹æš‚åœé˜Ÿåˆ—

**ç›®æ ‡**: ç®¡ç†å¤šä¸ªæš‚åœçš„è¯·æ±‚

**åŠŸèƒ½**:
- æŸ¥çœ‹æ‰€æœ‰æš‚åœçš„è¯·æ±‚
- æ‰¹é‡æ¢å¤
- è¶…æ—¶è‡ªåŠ¨æ”¾è¡Œ

**UI**:
```
â”Œâ”€ æš‚åœçš„è¯·æ±‚ (3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. POST /api/login        å‘½ä¸­ 1 åˆ†é’Ÿ        â”‚
â”‚  2. GET /api/user          å‘½ä¸­ 30 ç§’         â”‚
â”‚  3. POST /api/order        å‘½ä¸­ 5 ç§’          â”‚
â”‚  [å…¨éƒ¨æ”¾è¡Œ] [å…¨éƒ¨ä¸¢å¼ƒ]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢„ä¼°**: 2 å¤©

---

### 2.2 è¯·æ±‚é‡è¯•

**ç›®æ ‡**: æ–­ç‚¹å‘½ä¸­åå¯é‡æ–°å‘èµ·è¯·æ±‚

**åŠŸèƒ½**:
- ä¿®æ”¹åé‡è¯•
- é‡è¯•æ¬¡æ•°é™åˆ¶
- é‡è¯•é—´éš”é…ç½®

**é¢„ä¼°**: 2 å¤©

---

### 2.3 æ–­ç‚¹é“¾

**ç›®æ ‡**: æ”¯æŒè¯·æ±‚â†’å“åº”æ–­ç‚¹é“¾å¼è°ƒè¯•

**æµç¨‹**:
```
è¯·æ±‚å‘å‡º â†’ è¯·æ±‚æ–­ç‚¹ï¼ˆå¯ä¿®æ”¹ï¼‰â†’ å‘é€åˆ°æœåŠ¡å™¨
    â†“
å“åº”è¿”å› â† å“åº”æ–­ç‚¹ï¼ˆå¯ä¿®æ”¹ï¼‰â† æœåŠ¡å™¨å“åº”
```

**é¢„ä¼°**: 2 å¤©

---

### 2.4 æ–­ç‚¹è„šæœ¬

**ç›®æ ‡**: ä½¿ç”¨è„šæœ¬è‡ªåŠ¨å¤„ç†æ–­ç‚¹

**è„šæœ¬ç¤ºä¾‹**:
```javascript
// è‡ªåŠ¨æ·»åŠ  Header
function onRequestBreakpoint(request) {
  request.headers['X-Debug'] = 'true'
  return 'continue'  // æˆ– 'drop'
}

// è‡ªåŠ¨ä¿®æ”¹å“åº”
function onResponseBreakpoint(response) {
  if (response.statusCode === 401) {
    response.body = { "error": "mock_auth_error" }
  }
  return 'continue'
}
```

**é¢„ä¼°**: 4 å¤©

---

## Phase 3: é«˜çº§åŠŸèƒ½ (ä¼˜å…ˆçº§: ğŸ”µ Low)

### 3.1 æ–­ç‚¹å½•åˆ¶

**ç›®æ ‡**: å½•åˆ¶æ–­ç‚¹è°ƒè¯•è¿‡ç¨‹

**åŠŸèƒ½**:
- å½•åˆ¶ä¿®æ”¹æ“ä½œ
- å›æ”¾è°ƒè¯•è¿‡ç¨‹
- ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹

**é¢„ä¼°**: 4 å¤©

---

### 3.2 è¿œç¨‹è°ƒè¯•

**ç›®æ ‡**: å¤šäººååŒè°ƒè¯•

**åŠŸèƒ½**:
- åˆ†äº«æ–­ç‚¹çŠ¶æ€
- å¤šäººåŒæ—¶æŸ¥çœ‹
- èŠå¤©åŠŸèƒ½

**é¢„ä¼°**: 5 å¤©

---

### 3.3 æ–­ç‚¹æ¨¡æ¿

**ç›®æ ‡**: ä¿å­˜å¸¸ç”¨æ–­ç‚¹é…ç½®

**åŠŸèƒ½**:
- ä¿å­˜å½“å‰æ–­ç‚¹é…ç½®
- å¿«é€Ÿåº”ç”¨æ¨¡æ¿
- æ¨¡æ¿åˆ†äº«

**é¢„ä¼°**: 2 å¤©

---

## Phase 4: æ€§èƒ½ä¿æŠ¤ (ä¼˜å…ˆçº§: ğŸŸ¡ Medium)

### 4.1 æ–­ç‚¹è¶…æ—¶

**ç›®æ ‡**: é˜²æ­¢æ–­ç‚¹é•¿æ—¶é—´é˜»å¡è¯·æ±‚

**é…ç½®**:
```typescript
interface BreakpointTimeout {
  requestTimeout: number  // è¯·æ±‚æ–­ç‚¹è¶…æ—¶ï¼ˆç§’ï¼‰
  responseTimeout: number  // å“åº”æ–­ç‚¹è¶…æ—¶ï¼ˆç§’ï¼‰
  defaultAction: 'continue' | 'drop'  // è¶…æ—¶åé»˜è®¤åŠ¨ä½œ
}
```

**é¢„ä¼°**: 1 å¤©

---

### 4.2 æ–­ç‚¹é™æµ

**ç›®æ ‡**: é™åˆ¶åŒæ—¶æš‚åœçš„è¯·æ±‚æ•°é‡

**é…ç½®**:
```typescript
interface BreakpointRateLimit {
  maxPausedRequests: number  // æœ€å¤§æš‚åœæ•°
  overflowAction: 'drop' | 'continue' | 'queue'
}
```

**é¢„ä¼°**: 1 å¤©

---

### 4.3 è‡ªåŠ¨è·³è¿‡

**ç›®æ ‡**: æ™ºèƒ½è·³è¿‡ä¸é‡è¦çš„æ–­ç‚¹

**è§„åˆ™**:
- é™æ€èµ„æºè‡ªåŠ¨è·³è¿‡
- é‡å¤è¯·æ±‚è‡ªåŠ¨è·³è¿‡
- é«˜é¢‘è¯·æ±‚é‡‡æ ·

**é¢„ä¼°**: 2 å¤©

---

## ğŸ“Š ä¼˜å…ˆçº§æ€»è§ˆ

| é˜¶æ®µ | åŠŸèƒ½ | é¢„ä¼° | çŠ¶æ€ |
|------|------|------|------|
| **Phase 0** | æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€ | 0.5 å¤© | ğŸ”´ å¾…ä¿®å¤ |
| | ç½‘ç»œå±‚é›†æˆ | 1 å¤© | ğŸ”´ å¾…ä¿®å¤ |
| | breakpointHit å¤„ç† | 0.5 å¤© | ğŸ”´ å¾…ä¿®å¤ |
| **Phase 1** | è¯·æ±‚ä¿®æ”¹ | 3 å¤© | å¾…å¼€å‘ |
| | å“åº”ä¿®æ”¹ | 2 å¤© | å¾…å¼€å‘ |
| | æ¡ä»¶æ–­ç‚¹ | 3 å¤© | å¾…å¼€å‘ |
| | æ–­ç‚¹å‘½ä¸­é€šçŸ¥ | 1 å¤© | å¾…å¼€å‘ |
| **Phase 2** | æ–­ç‚¹æš‚åœé˜Ÿåˆ— | 2 å¤© | å¾…å¼€å‘ |
| | è¯·æ±‚é‡è¯• | 2 å¤© | å¾…å¼€å‘ |
| | æ–­ç‚¹é“¾ | 2 å¤© | å¾…å¼€å‘ |
| | æ–­ç‚¹è„šæœ¬ | 4 å¤© | å¾…å¼€å‘ |
| **Phase 3** | æ–­ç‚¹å½•åˆ¶ | 4 å¤© | å¾…å¼€å‘ |
| | è¿œç¨‹è°ƒè¯• | 5 å¤© | å¾…å¼€å‘ |
| | æ–­ç‚¹æ¨¡æ¿ | 2 å¤© | å¾…å¼€å‘ |
| **Phase 4** | æ–­ç‚¹è¶…æ—¶ | 1 å¤© | å¾…å¼€å‘ |
| | æ–­ç‚¹é™æµ | 1 å¤© | å¾…å¼€å‘ |
| | è‡ªåŠ¨è·³è¿‡ | 2 å¤© | å¾…å¼€å‘ |
